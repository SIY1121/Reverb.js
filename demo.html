<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reverb.js - Demo</title>
    <style>
      body {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div style='font-size:48px;'>Reverb.js</div>
    <hr/>
<!--BEGIN REVERBJS-->
<script type="text/javascript">
/*global ArrayBuffer, Uint8Array, window, XMLHttpRequest*/
var reverbjs = {
  extend : function (audioContext) {
    function decodeBase64ToArrayBuffer(input) {
      function encodedValue(input, index) {
        var encodedCharacter, x = input.charCodeAt(index);
        if (index < input.length) {
          if (x >= 65 && x <= 90) {
            encodedCharacter = x - 65;
          } else if (x >= 97 && x <= 122) {
            encodedCharacter = x - 71;
          } else if (x >= 48 && x <= 57) {
            encodedCharacter = x + 4;
          } else if (x === 43) {
            encodedCharacter = 62;
          } else if (x === 47) {
            encodedCharacter = 63;
          } else if (x !== 61) {
            console.log('base64 encountered unexpected character code: ' + x);
          }
        }
        return encodedCharacter;
      }

      if (input.length === 0 || (input.length % 4) > 0) {
        console.log('base64 encountered unexpected length: ' + input.length);
        return;
      }

      var padding = input.match(/[=]*$/)[0].length,
        decodedLength = input.length * 3 / 4 - padding,
        buffer = new ArrayBuffer(decodedLength),
        bufferView = new Uint8Array(buffer),
        encoded = [],
        d = 0,
        e = 0,
        i;

      while (d < decodedLength) {
        for (i = 0; i < 4; i += 1) {
          encoded[i] = encodedValue(input, e);
          e += 1;
        }
        bufferView[d] = (encoded[0] * 4) + Math.floor(encoded[1] / 16);
        d += 1;
        if (d < decodedLength) {
          bufferView[d] = ((encoded[1] % 16) * 16) + Math.floor(encoded[2] / 4);
          d += 1;
        }
        if (d < decodedLength) {
          bufferView[d] = ((encoded[2] % 4) * 64) + encoded[3];
          d += 1;
        }
      }
      return buffer;
    }

    function decodeAndSetupBuffer(node, arrayBuffer, callback) {
      audioContext.decodeAudioData(arrayBuffer, function (audioBuffer) {
        console.log('Finished decoding audio data.');
        node.buffer = audioBuffer;
        if (typeof callback === "function" && audioBuffer !== null) {
          callback(node);
        }
      }, function (e) {
        console.log('Could not decode audio data: ' + e);
      });
    }

    audioContext.createReverbFromBase64 = function (audioBase64, callback) {
      var reverbNode = audioContext.createConvolver();
      decodeAndSetupBuffer(reverbNode, decodeBase64ToArrayBuffer(audioBase64),
        callback);
      return reverbNode;
    };

    audioContext.createReverbFromUrl = function (audioUrl, callback) {
      console.log('Downloading impulse response from ' + audioUrl);
      var reverbNode = audioContext.createConvolver(),
        request = new XMLHttpRequest();
      request.onreadystatechange = function () {
        if (request.readyState === 4 && request.status === 200) {
          console.log('Downloaded impulse response');
          decodeAndSetupBuffer(reverbNode, request.response, callback);
        }
      };
      request.onerror = function (e) {
        console.log('There was an error receiving the response: ' + e);
        reverbjs.networkError = e;
      };
      request.responseType = 'arraybuffer';
      request.open('GET', audioUrl, true);
      request.send();
      return reverbNode;
    };
  }
};
</script><!--END REVERBJS-->
<script type="text/javascript">
var reverb, masterGain, context;

function dBToGain(dB) {
  return (dB <= -100) ? 0 : Math.pow(10, dB / 10);
}

function initialize () {
  context = new (window.AudioContext || window.webkitAudioContext)();
  reverbjs.extend(context);
  masterGain = context.createGain();
  masterGain.gain.value = 1;
  masterGain.connect(context.destination);
}

function midiNoteNumberToFrequency (midiNoteNumber) {
  return 55 * Math.pow(2, (midiNoteNumber - 33) / 12);
}

function playScale () {
  var i, loudness = 0.1;
  var notesGoingUp = [60, 62, 64, 65, 67, 69, 71, 72]
  var notesGoingDown = [48, 47, 45, 43, 41, 40, 38, 36];
  var s = context.currentTime;
  for (i = 0; i < notesGoingUp.length; i++) {
    scheduleSynthNote(notesGoingUp[i], s + 0.1 + i * 0.5, 0.25, loudness);
    scheduleSynthNote(notesGoingDown[i], s + 0.1 + i * 0.5, 0.25, loudness);
  }
}

function scheduleOscillator(type, note, startTime, duration, gain, shape) {
  var gainShaper = context.createGain();
  gainShaper.gain.value = 0;
  gainShaper.gain.setValueAtTime(0, startTime);
  for (var i in shape) {
    var g = dBToGain(shape[i].dB) * gain;
    var t = startTime + shape[i].time * duration;
    gainShaper.gain.linearRampToValueAtTime(g, t);
  }
  gainShaper.connect(reverb);
  
  var oscillator = context.createOscillator();
  oscillator.type = type;
  oscillator.frequency.value = midiNoteNumberToFrequency(note);
  oscillator.start(startTime);
  oscillator.stop(startTime + duration);
  oscillator.connect(gainShaper);
}

function scheduleSynthNote (note, start, duration, gain) {
  gain /= dBToGain(-55);
  scheduleOscillator('triangle', note, start, duration, gain,
    [{time:0.05, dB:-65},{time:0.95, dB:-65},{time:1.0, dB:-100}]);
  scheduleOscillator('sawtooth', note + 12, start, duration, gain,
    [{time:0.05, dB:-55},{time:0.95, dB:-60},{time:1.0, dB:-100}]);
  scheduleOscillator('sine', note + 24, start, duration, gain,
    [{time:0.2, dB:-58},{time:0.95, dB:-58},{time:1.0, dB:-100}]);
  scheduleOscillator('square', note + 48, start, duration, gain,
    [{time:0.2, dB:-75},{time:0.95, dB:-75},{time:1.0, dB:-100}]);
}

function shutdownGracefully () {
  var start = context.currentTime, length = 0.5, progress = 0;
  while (progress <= 1) {
    masterGain.gain.value = 1 - progress;
    progress = (context.currentTime - start) / length;
  }
}

function testReverb (url) {
  reverb = context.createReverbFromUrl(url, function() { playScale(); });
  reverb.connect(masterGain);
}

window.onload = initialize;
window.onbeforeunload = shutdownGracefully;
        </script>
<!--BEGIN GENERATED-->
<h1>InsidePiano <a href="javascript:testReverb('https://rawgit.com/burnson/Reverb.js/master/Library/InsidePiano.wav');">(listen)</a></h1>
<h2>Attribution</h2><p>Recorded by William Andrew Burnson (2013)<br/>An impulse response recorded from just outside a Yamaha baby grand piano with the damper pedal down.<br/><br/>Attribution Share Alike Creative Commons<br/>http://creativecommons.org/licenses/by-sa/3.0/
</p>
<h2>Usage</h2>
<pre>var audioContext = (your audio context);
reverbjs.extend(audioContext);
var reverbUrl = "https://rawgit.com/burnson/Reverb.js/master/Library/InsidePiano.wav";
var reverbNode = audioContext.createReverbFromUrl(reverbUrl, function() {
  console.log("Loaded reverb " + reverbUrl);
});
reverbNode.connect(audioContext.destination);
(some source node).connect(reverbNode);
</pre>
<h1>MidiverbMark2Preset29 <a href="javascript:testReverb('https://rawgit.com/burnson/Reverb.js/master/Library/MidiverbMark2Preset29.wav');">(listen)</a></h1>
<h2>Attribution</h2><p>Recorded by William Andrew Burnson (2011)<br/>An impulse response recorded from preset 29 on an Alesis Midiverb II.<br/><br/>Attribution Share Alike Creative Commons<br/>http://creativecommons.org/licenses/by-sa/3.0/
</p>
<h2>Usage</h2>
<pre>var audioContext = (your audio context);
reverbjs.extend(audioContext);
var reverbUrl = "https://rawgit.com/burnson/Reverb.js/master/Library/MidiverbMark2Preset29.wav";
var reverbNode = audioContext.createReverbFromUrl(reverbUrl, function() {
  console.log("Loaded reverb " + reverbUrl);
});
reverbNode.connect(audioContext.destination);
(some source node).connect(reverbNode);
</pre>
<h1>StMarysAbbeyReconstructionPhase1 <a href="javascript:testReverb('https://rawgit.com/burnson/Reverb.js/master/Library/StMarysAbbeyReconstructionPhase1.wav');">(listen)</a></h1>
<h2>Attribution</h2><p>By OpenAirLib (2011)<br/>http://www.openairlib.net/auralizationdb/content/st-marys-abbey-reconstruction<br/><br/>"The abbey of St. Mary was mostly destroyed during the dissolution under the rule of Henry VIII and now only ruins remain. These ruins can be found in the Museum Gardens adjacent to the river Ouse in York city. Virtual models of this now derelict church were built using measurements taken from scaled plans and other sources of architectural evidence. Impulse responses were then created using ray-based room acoustic modelling software. Three different models of the church were used with increasing levels of detail in their geometric structure, referred to as Phase 1, Phase 2 and Phase 3. The work was carried out as part of a Bachelor of Engineering project at the Audiolab in the University of York."<br/><br/>Attribution Share Alike Creative Commons<br/>http://creativecommons.org/licenses/by-sa/3.0/<br/>
</p>
<h2>Usage</h2>
<pre>var audioContext = (your audio context);
reverbjs.extend(audioContext);
var reverbUrl = "https://rawgit.com/burnson/Reverb.js/master/Library/StMarysAbbeyReconstructionPhase1.wav";
var reverbNode = audioContext.createReverbFromUrl(reverbUrl, function() {
  console.log("Loaded reverb " + reverbUrl);
});
reverbNode.connect(audioContext.destination);
(some source node).connect(reverbNode);
</pre>
<!--END GENERATED-->
    </body>
</html>