#!/usr/bin/env ruby
repo_dir = File.expand_path(File.dirname(__FILE__))
Dir.chdir(repo_dir)

def verbose(command)
  puts "--> #{command}"
  system(command) or raise("Failed: #{command}")
end

verbose('jslint --indent 2 --sloppy --stupid --evil reverb.js')
verbose('uglifyjs reverb.js --compress > reverb.min.js')

demo = File.read('index.html')

generated = "<!--BEGIN GENERATED-->\n"
Dir.glob('Library/*.wav') {|file|
  url = 'http://reverbjs.org/' + file
  name = File.basename(file, File.extname(file))
  description = File.read('Library/' + name + '.attribution.txt')
  x = ''
  x += "<h2>#{name} "
  x += '<a href="javascript:testReverb('
  x += "'#{url}'"
  x += ');">'
  x += "(listen)"
  x += "</a></h2>\n"
  x += "<h3>Attribution</h3>"
  x += "<p>"
  x += description.gsub("\n", "<br/>") + "\n"
  x += "</p>\n"
  x += "<h3>Usage</h3>\n"
  x += "<pre><code>"
  x += "var audioContext = (your audio context);\n"
  x += "reverbjs.extend(audioContext);\n"
  x += "var reverbUrl = \"#{url}\";\n"
  x += "var reverbNode = audioContext.createReverbFromUrl(reverbUrl, function() {\n"
  x += "  console.log(\"Loaded reverb \" + reverbUrl);\n"
  x += "});\n"
  x += "reverbNode.connect(audioContext.destination);\n"
  x += "(some source node).connect(reverbNode);\n"
  x += "</code></pre>\n"
  generated += x
}
generated += "<!--END GENERATED-->"
reverbjs = "<!--BEGIN REVERBJS-->\n"
reverbjs += "<script type=\"text/javascript\">\n"
reverbjs += File.read('reverb.js')
reverbjs += "</script>"
reverbjs += "<!--END REVERBJS-->"

demo = demo.gsub(/[<].--BEGIN GENERATED.*END GENERATED--[>]/m) {generated}
demo = demo.gsub(/[<].--BEGIN REVERBJS.*END REVERBJS--[>]/m) {reverbjs}
File.write('index.html', demo)